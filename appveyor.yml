
skip_commits:
  files:
    - docs/*
    - 'manual/*'
    - '**/*.rst'
    - '**/*.md'


# We have to disable the `build` command explicitly otherwise the default is
# MSBuild which assumes this is a Visual Studio project. Python source/binary
# wheels a Windows .exe are generated below in `install`.
build: false


environment:
  matrix:
    - PYTHON: "C:\\Python37-x64"
    - PYTHON: "C:\\Python38-x64"
    - PYTHON: "C:\\Python39-x64"


install:
  # Setup Python environment and update basic packages.
  - 'SET PATH=%PYTHON%;%PYTHON%\\Scripts;%PATH%'
  - python --version
  - python -m pip install --upgrade pip
  - python -m pip install --upgrade setuptools wheel pyinstaller==4.10

  # Install PySceneDetect dependencies and checkout resources required for tests.
  - python -m pip install -r dist/requirements_windows.txt
  - git fetch --depth=1 https://github.com/Breakthrough/PySceneDetect.git refs/heads/resources:refs/remotes/origin/resources
  - git checkout refs/remotes/origin/resources -- tests/resources/
  - git checkout refs/remotes/origin/resources -- dist/

  # Build Python package
  - python setup.py sdist bdist_wheel

  # Build Windows .EXE
  - pyinstaller dist/scenedetect.spec

  # Bundle Windows .EXE distribution with all dependencies.
  - python dist/cleanup_dependencies.py
  - cd dist/scenedetect
  - 7z a ../scenedetect-win64.zip *
  - cd ../..

  # TODO: Rename using APPVEYOR_REPO_COMMIT env var and inline Powershell script if this is not
  # a tagged commit.


test_script:
  # Checkout Windows dependencies and extract them.
  - git checkout refs/remotes/origin/resources -- dist/
  - git checkout refs/remotes/origin/build-windows -- dist/
  - 7z e dist/windows_thirdparty.7z

  # Run Unit Tests
  - pytest

  # Test Windows Build
  - cd dist/scenedetect
  - scenedetect.exe version
  - scenedetect.exe -i ../../tests/resources/testvideo.mp4 -b opencv detect-content time -e 2s
  - scenedetect.exe -i ../../tests/resources/testvideo.mp4 -b pyav detect-content time -e 2s

  # TODO: Test Python Distributions
  # Wildcard expansion doesn't seem to work with pip here, e.g. the following fails:
  #- python -m pip install dist\*.whl


artifacts:
  - path: dist/scenedetect-win64.zip
    name: PySceneDetect-win64_portable

  - path: dist/scenedetect/scenedetect.exe
    name: PySceneDetect-win64_exeonly

  - path: dist/*.tar.gz
    name: PySceneDetect-sdist

  - path: dist/*.whl
    name: PySceneDetect-bdist_wheel
